<template>
  <PlusForm
    ref="plusFormInstance"
    v-model="state.values"
    :inline="inline"
    :row-props="rowProps"
    :col-props="colProps"
    :columns="subColumns"
    :has-footer="false"
    class="plus-search"
    v-bind="$attrs"
    @change="handleChange"
  >
    <template #search-footer>
      <el-form-item v-if="hasFooter" class="plus-search__button__wrapper">
        <el-button v-if="hasReset" :icon="RefreshRight" @click="handleReset">
          {{ resetText || t('plus.search.resetText') }}
        </el-button>
        <el-button type="primary" :loading="searchLoading" :icon="Search" @click="handleSearch">
          {{ searchText || t('plus.search.searchText') }}
        </el-button>

        <el-button
          v-if="hasUnfold && state.originData.length > showNumber"
          type="primary"
          link
          @click="handleUnfold"
        >
          {{ isShowUnfold ? t('plus.search.retract') : t('plus.search.expand') }}
          <el-icon>
            <ArrowUp v-if="isShowUnfold" />
            <ArrowDown v-else />
          </el-icon>
        </el-button>
      </el-form-item>
    </template>
  </PlusForm>
</template>

<script lang="ts" setup>
import type { PlusFormInstance } from '@plus-pro-components/components/form'
import { PlusForm } from '@plus-pro-components/components/form'
import type { Ref } from 'vue'
import { reactive, ref, toRefs, computed, watch } from 'vue'
import type { FormProps, RowProps, ColProps } from 'element-plus'
import { ArrowDown, ArrowUp, Search, RefreshRight } from '@element-plus/icons-vue'
import type { PlusColumn, FieldValues, Mutable } from '@plus-pro-components/types'
import { cloneDeep } from 'lodash-es'
import { useLocale } from '@plus-pro-components/hooks'
import { ElFormItem, ElButton, ElIcon } from 'element-plus'

export interface PlusSearchProps extends /* @vue-ignore */ Partial<Mutable<FormProps>> {
  modelValue?: FieldValues
  columns?: PlusColumn[]
  hasFooter?: boolean
  hasReset?: boolean
  hasUnfold?: boolean
  searchText?: string
  resetText?: string
  searchLoading?: boolean
  inline?: boolean
  showNumber?: number
  rowProps?: Partial<Mutable<RowProps>>
  colProps?: Partial<Mutable<ColProps>>
}
export interface PlusSearchState {
  values: FieldValues
  isShowUnfold: boolean
  subColumns: any
  originData: any
}
export interface PlusSearchEmits {
  (e: 'update:modelValue', values: FieldValues): void
  (e: 'search', values: FieldValues): void
  (e: 'change', values: FieldValues, column: PlusColumn): void
  (e: 'reset'): void
}

defineOptions({
  name: 'PlusSearch'
})

const props = withDefaults(defineProps<PlusSearchProps>(), {
  modelValue: () => ({}),
  hasFooter: true,
  hasReset: true,
  hasUnfold: true,
  searchLoading: false,
  searchText: '',
  resetText: '',
  inline: true,
  showNumber: 2,
  columns: () => [],
  rowProps: () => ({
    gutter: 20
  }),
  colProps: () => ({
    xs: 24,
    sm: 12,
    md: 8,
    lg: 8,
    xl: 6
  })
})
const emit = defineEmits<PlusSearchEmits>()

const { t } = useLocale()
const plusFormInstance = ref<any>()
const state = reactive<PlusSearchState>({
  values: {},
  subColumns: [],
  originData: [],
  isShowUnfold: false
})

state.originData = computed<any[]>(() => {
  return props.columns.filter(item => item.hideInSearch !== true)
})

state.subColumns = computed<any[]>(() => {
  const data = cloneDeep(state.originData)
  if (props.hasUnfold && !state.isShowUnfold) {
    return data.slice(0, props.showNumber)
  } else {
    return data
  }
})

watch(
  () => props.modelValue,
  val => {
    state.values = val
  },
  {
    deep: true,
    immediate: true
  }
)

const handleChange = async (values: FieldValues, column: PlusColumn) => {
  emit('change', values, column)
  emit('update:modelValue', values)
}

const handleSearch = async () => {
  emit('search', cloneDeep(state.values))
}

const handleReset = (): void => {
  state.values = {}
  emit('reset')
}

const handleUnfold = () => {
  state.isShowUnfold = !state.isShowUnfold
}

defineExpose({
  plusFormInstance: plusFormInstance as Ref<PlusFormInstance>
})

const { isShowUnfold, subColumns } = toRefs(state)
</script>
